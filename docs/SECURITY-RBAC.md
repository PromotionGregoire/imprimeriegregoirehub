# S√©curit√© et contr√¥le d'acc√®s (RBAC) - PromoFlow

## Vue d'ensemble de la s√©curit√©

L'application PromoFlow impl√©mente un syst√®me de s√©curit√© multicouche bas√© sur les principes du **Zero Trust** et du **Role-Based Access Control (RBAC)**, garantissant que chaque utilisateur n'acc√®de qu'aux donn√©es et fonctionnalit√©s n√©cessaires √† son r√¥le.

## 1. Architecture de s√©curit√©

### 1.1 Couches de s√©curit√©

```mermaid
flowchart TD
    A[Client Web] --> B[CDN/Firewall]
    B --> C[Load Balancer]
    C --> D[Application React]
    D --> E[Supabase Auth]
    E --> F[Row Level Security]
    F --> G[Database PostgreSQL]
    
    H[Edge Functions] --> I[Service Role Auth]
    I --> F
    
    J[External APIs] --> K[API Keys/Tokens]
    K --> H
```

### 1.2 Principes de s√©curit√© appliqu√©s

1. **Authentification forte** : Multi-facteur disponible
2. **Autorisation granulaire** : RLS au niveau ligne
3. **Chiffrement** : En transit (TLS) et au repos
4. **Auditabilit√©** : Logs complets des actions
5. **Principe du moindre privil√®ge** : Acc√®s minimum n√©cessaire
6. **Defense in depth** : Validation client ET serveur

## 2. Gestion des utilisateurs et r√¥les

### 2.1 Hi√©rarchie des r√¥les

```mermaid
flowchart TD
    A[admin] --> B[manager]
    B --> C[employee]
    A --> D[client]
    
    A -.-> E[Toutes permissions]
    B -.-> F[Gestion √©quipe + Production]
    C -.-> G[Op√©rations quotidiennes]
    D -.-> H[Consultation limit√©e]
```

### 2.2 D√©finition des r√¥les

#### Admin (Administrateur syst√®me)
```sql
-- Permissions compl√®tes
GRANT ALL ON ALL TABLES IN SCHEMA public TO admin_role;
```

**Capacit√©s:**
- ‚úÖ Gestion compl√®te des utilisateurs
- ‚úÖ Configuration syst√®me
- ‚úÖ Acc√®s aux logs et m√©triques
- ‚úÖ Gestion des fournisseurs
- ‚úÖ Administration base de donn√©es
- ‚úÖ Backup et restauration

**Restrictions:**
- ‚ùå Aucune (r√¥le super-admin)

#### Manager (Gestionnaire)
**Capacit√©s:**
- ‚úÖ Cr√©ation/modification employ√©s
- ‚úÖ Validation devis > seuil
- ‚úÖ Acc√®s dashboard analytique
- ‚úÖ Gestion clients strat√©giques
- ‚úÖ Pilotage production
- ‚úÖ Export donn√©es m√©tier

**Restrictions:**
- ‚ùå Configuration syst√®me
- ‚ùå Gestion autres managers
- ‚ùå Acc√®s logs techniques

#### Employee (Employ√©)
**Capacit√©s:**
- ‚úÖ Cr√©ation devis clients
- ‚úÖ Gestion BAT/production
- ‚úÖ Communication clients
- ‚úÖ Suivi commandes
- ‚úÖ Mise √† jour statuts

**Restrictions:**
- ‚ùå Validation devis √©lev√©s
- ‚ùå Gestion utilisateurs
- ‚ùå Configuration produits
- ‚ùå Acc√®s donn√©es financi√®res

#### Client (Client externe)
**Capacit√©s:**
- ‚úÖ Consultation ses devis
- ‚úÖ Validation/rejet commandes
- ‚úÖ Commentaires sur BAT
- ‚úÖ Suivi statut ses commandes

**Restrictions:**
- ‚ùå Acc√®s donn√©es autres clients
- ‚ùå Interface administration
- ‚ùå Cr√©ation directe commandes

### 2.3 Matrice de permissions d√©taill√©e

| Ressource | Admin | Manager | Employee | Client |
|-----------|--------|---------|----------|---------|
| **Utilisateurs** |
| Cr√©er admin | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| Cr√©er manager | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| Cr√©er employee | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Modifier profils | ‚úÖ | üë• | üîí | üîí |
| **Clients** |
| Cr√©er client | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Modifier client | ‚úÖ | ‚úÖ | üë§ | ‚ùå |
| Supprimer client | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Voir tous clients | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| **Soumissions** |
| Cr√©er soumission | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Modifier soumission | ‚úÖ | ‚úÖ | üë§ | ‚ùå |
| Valider > seuil | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Voir toutes | ‚úÖ | ‚úÖ | üë§ | üîí |
| **Production** |
| G√©rer commandes | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Cr√©er BAT | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Valider qualit√© | ‚úÖ | ‚úÖ | üë• | ‚ùå |
| **Syst√®me** |
| Configuration | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| Logs syst√®mes | ‚úÖ | üìä | ‚ùå | ‚ùå |
| Backup/Restore | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |

**L√©gende:**
- ‚úÖ Acc√®s complet
- ‚ùå Aucun acc√®s  
- üë§ Ses propres donn√©es seulement
- üë• √âquipe sous sa responsabilit√©
- üîí Donn√©es li√©es √† son profil
- üìä Vue read-only/dashboards

## 3. Row Level Security (RLS)

### 3.1 Impl√©mentation RLS par table

#### Table `profiles`
```sql
-- Admin: Acc√®s complet
CREATE POLICY "admin_profiles_full_access" ON profiles
FOR ALL TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM profiles p 
    WHERE p.id = auth.uid() 
    AND p.role = 'admin'
  )
);

-- Manager: Acc√®s √©quipe + lecture autres
CREATE POLICY "manager_profiles_access" ON profiles  
FOR SELECT TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM profiles p 
    WHERE p.id = auth.uid() 
    AND p.role IN ('admin', 'manager')
  )
);

-- Employee: Lecture limit√©e, modification profil perso
CREATE POLICY "employee_own_profile" ON profiles
FOR UPDATE TO authenticated  
USING (id = auth.uid());
```

#### Table `clients`
```sql
-- Visibilit√© selon r√¥le et propri√©t√©
CREATE POLICY "clients_access_by_role" ON clients
FOR SELECT TO authenticated
USING (
  CASE 
    WHEN EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('admin', 'manager'))
    THEN true
    WHEN EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'employee')
    THEN created_by = auth.uid() OR id IN (
      SELECT DISTINCT client_id FROM submissions WHERE created_by = auth.uid()
    )
    ELSE false
  END
);
```

#### Table `submissions`
```sql
-- Acc√®s granulaire selon r√¥le
CREATE POLICY "submissions_access_control" ON submissions
FOR SELECT TO authenticated
USING (
  -- Admin/Manager: tout voir
  EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('admin', 'manager'))
  OR
  -- Employee: ses cr√©ations + ses assignations
  created_by = auth.uid()
  OR
  -- Client: ses soumissions via token public (g√©r√© s√©par√©ment)
  false
);
```

#### Table `proofs` (Cas sp√©cial)
```sql
-- Acc√®s authentifi√© normal
CREATE POLICY "proofs_authenticated_access" ON proofs
FOR SELECT TO authenticated
USING (true);

-- Acc√®s public via token (pour validation client)
CREATE POLICY "proofs_public_token_access" ON proofs  
FOR SELECT TO anon
USING (
  approval_token IS NOT NULL 
  AND expires_at > now()
);
```

### 3.2 S√©curit√© des Edge Functions

```typescript
// Exemple: V√©rification r√¥le dans Edge Function
async function checkUserRole(userId: string, requiredRole: string[]): Promise<boolean> {
  const { data: profile } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', userId)
    .single();
    
  return requiredRole.includes(profile?.role);
}

// Utilisation dans handler
export async function handler(request: Request) {
  const token = request.headers.get('Authorization')?.replace('Bearer ', '');
  const { data: { user } } = await supabase.auth.getUser(token);
  
  // V√©rification r√¥le requis
  if (!await checkUserRole(user.id, ['admin', 'manager'])) {
    return new Response('Forbidden', { status: 403 });
  }
  
  // Traitement autoris√©...
}
```

## 4. Authentification et sessions

### 4.1 Configuration Supabase Auth

```typescript
// Configuration client
const supabase = createClient(
  'https://ytcrplsistsxfaxkfqqp.supabase.co',
  'anon_key',
  {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      flowType: 'pkce' // Plus s√©curis√©
    }
  }
);
```

### 4.2 Gestion des sessions

**Dur√©e de session:**
- Token d'acc√®s: 1 heure
- Refresh token: 30 jours  
- Session inactivit√©: 24 heures

**Renouvellement automatique:**
```typescript
// Hook personnalis√© pour g√©rer l'auth
export function useAuth() {
  useEffect(() => {
    // √âcoute changements session
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      (event, session) => {
        if (event === 'SIGNED_OUT' || !session) {
          // Nettoyage donn√©es sensibles
          clearClientCache();
          navigate('/login');
        }
      }
    );
    
    return () => subscription.unsubscribe();
  }, []);
}
```

### 4.3 Protection des routes

```typescript
// ProtectedRoute component
function ProtectedRoute({ children, requiredRole }: ProtectedRouteProps) {
  const { user, profile, loading } = useAuth();
  
  if (loading) return <LoadingSpinner />;
  
  if (!user) {
    return <Navigate to="/login" replace />;
  }
  
  if (requiredRole && !requiredRole.includes(profile?.role)) {
    return <AccessDenied />;
  }
  
  return <>{children}</>;
}
```

## 5. S√©curit√© des donn√©es

### 5.1 Chiffrement

**En transit:**
- TLS 1.3 pour toutes communications
- HTTPS forc√© (HSTS activ√©)
- Certificats SSL automatiques

**Au repos:**
- Chiffrement AES-256 base de donn√©es
- Stockage fichiers chiffr√©
- Cl√©s rot√©es automatiquement

**C√¥t√© client:**
- Stockage local minimal
- Pas de donn√©es sensibles en localStorage
- Session tokens en httpOnly cookies

### 5.2 Validation et sanitization

```typescript
// Sch√©mas Zod pour validation
const SubmissionSchema = z.object({
  title: z.string().min(3).max(200),
  description: z.string().optional(),
  client_id: z.string().uuid(),
  expected_delivery: z.date().min(new Date()),
  // Validation m√©tier
  total_amount: z.number().positive().max(100000)
});

// Sanitization automatique
function sanitizeInput(input: string): string {
  return input
    .trim()
    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
    .replace(/javascript:/gi, '')
    .substring(0, 1000); // Limite longueur
}
```

### 5.3 Protection CSRF

```typescript
// Tokens CSRF pour formulaires critiques
const CSRFToken = () => {
  const [token, setToken] = useState<string>();
  
  useEffect(() => {
    // G√©n√©ration token c√¥t√© client
    setToken(crypto.randomUUID());
  }, []);
  
  return <input type="hidden" name="_csrf" value={token} />;
};
```

## 6. Audit et monitoring

### 6.1 Logs de s√©curit√©

```sql
-- Table audit automatique
CREATE TABLE security_logs (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  action TEXT NOT NULL,
  resource TEXT,
  ip_address INET,
  user_agent TEXT,
  success BOOLEAN DEFAULT true,
  error_message TEXT,
  created_at TIMESTAMP DEFAULT now()
);

-- Trigger automatique sur actions sensibles
CREATE OR REPLACE FUNCTION log_security_event()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO security_logs (user_id, action, resource, success)
  VALUES (auth.uid(), TG_OP, TG_TABLE_NAME, true);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### 6.2 Alertes de s√©curit√©

**D√©clencheurs d'alerte:**
- Tentatives connexion multiples √©chou√©es
- Acc√®s donn√©es client par utilisateur non autoris√©
- Modification massive de donn√©es
- Acc√®s √† des endpoints non autoris√©s
- T√©l√©chargement massif de donn√©es

**Actions automatiques:**
- Blocage temporaire IP
- Notification admin imm√©diate
- R√©vocation session suspecte
- Audit approfondi d√©clench√©

### 6.3 M√©triques de s√©curit√©

| M√©trique | Seuil | Action |
|----------|--------|--------|
| √âchecs connexion/heure | > 20 | Alerte + blocage IP |
| Requ√™tes/minute/utilisateur | > 100 | Rate limiting |
| Acc√®s donn√©es non autoris√©es | > 1 | Investigation imm√©diate |
| Modifications admin | Toute | Log + notification |
| Dur√©e session anormale | > 12h | V√©rification automatique |

## 7. Conformit√© et r√©glementation

### 7.1 RGPD/GDPR

**Droits utilisateurs impl√©ment√©s:**
- ‚úÖ Droit d'acc√®s (export donn√©es personnelles)
- ‚úÖ Droit de rectification (modification profil)
- ‚úÖ Droit √† l'effacement ("droit √† l'oubli")
- ‚úÖ Portabilit√© des donn√©es (export JSON)
- ‚úÖ Consentement explicite (cookies, newsletters)

```typescript
// Fonction anonymisation RGPD
async function anonymizeUserData(userId: string) {
  await supabase.rpc('anonymize_user', {
    user_id: userId,
    // Conserve donn√©es m√©tier, anonymise donn√©es perso
    keep_business_data: true
  });
}
```

### 7.2 Politique de r√©tention

| Type de donn√©e | Dur√©e conservation | Action apr√®s |
|----------------|-------------------|---------------|
| Logs connexion | 1 an | Archivage s√©curis√© |
| Donn√©es clients | 7 ans (l√©gal) | Anonymisation |
| Fichiers BAT | 3 ans | Suppression |
| Logs audit | 5 ans | Archivage froid |
| Sessions actives | 30 jours | Nettoyage auto |

## 8. Plan de r√©ponse incident

### 8.1 Classification des incidents

**Niveau 1 - Critique:**
- Compromission donn√©es clients
- Acc√®s non autoris√© admin
- Faille s√©curit√© exploit√©e

**Niveau 2 - Important:**  
- Tentatives intrusion r√©p√©t√©es
- Dysfonctionnement authentification
- Fuite donn√©es non sensibles

**Niveau 3 - Mineur:**
- Tentatives acc√®s isol√©es  
- Erreurs configuration mineures
- Alertes pr√©ventives

### 8.2 Proc√©dure de r√©ponse

```mermaid
flowchart TD
    A[D√©tection incident] --> B{Niveau critique?}
    B -->|Oui| C[Isolation imm√©diate]
    B -->|Non| D[Investigation approfondie]
    C --> E[Notification CISO]
    E --> F[Analyse impact]
    F --> G[Communication client si requis]
    G --> H[Correction + Post-mortem]
    D --> I[Correctif pr√©ventif]
    I --> H
```

## 9. Roadmap s√©curit√©

### Phase 1 (Imm√©diat)
- ‚úÖ Audit de s√©curit√© complet effectu√©
- üîÑ Renforcement RLS policies
- üìã Tests penetration externes

### Phase 2 (3 mois)
- üìã Impl√©mentation MFA obligatoire
- üìã Chiffrement bout-en-bout fichiers
- üìã SOC/SIEM integration

### Phase 3 (6 mois)
- üìã Certification ISO 27001
- üìã Zero Trust architecture compl√®te
- üìã IA d√©tection anomalies

**L√©gende:**
- ‚úÖ Impl√©ment√©
- üîÑ En cours
- üìã Planifi√©